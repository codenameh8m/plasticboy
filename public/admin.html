<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>PlasticBoy - Admin Panel</title>
    <link rel="preload" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" as="style">
    <link rel="preload" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" as="script">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>PlasticBoy Admin</h1>
            <p>Collection points management</p>
        </header>

        <!-- Login form -->
        <div id="loginForm" class="form-container">
            <h2>Admin panel login</h2>
            <input type="password" id="adminPassword" placeholder="Administrator password" autocomplete="current-password">
            <button onclick="adminLogin()" id="loginBtn">Login</button>
            <div id="loginError" style="display: none; color: #f44336; margin-top: 10px; text-align: center; font-size: 0.9rem;"></div>
        </div>

        <!-- Admin panel -->
        <div id="adminPanel" style="display: none;">
            <div class="admin-controls">
                <h3>Add new point</h3>
                <p>Click on the map to add a point</p>
                <button id="addModeBtn" onclick="toggleAddMode()">Add mode: OFF</button>
            </div>

            <div class="stats admin-stats">
                <div class="stat-item">
                    <span class="stat-number" id="totalPoints">0</span>
                    <span class="stat-label">Total points</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="activePoints">0</span>
                    <span class="stat-label">Active</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="scheduledPoints">0</span>
                    <span class="stat-label">Scheduled</span>
                </div>
            </div>

            <!-- Map container -->
            <div class="map-container">
                <div id="adminMap"></div>
            </div>

            <!-- Location button -->
            <div class="map-controls">
                <button class="control-btn location-btn" onclick="getAdminLocation()">
                    üìç My location
                </button>
            </div>

            <div class="points-list">
                <h3>Points list</h3>
                <div id="pointsList"></div>
            </div>
        </div>
    </div>

    <!-- Modal window for adding point -->
    <div id="addPointModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAddModal()">&times;</span>
            <h2>Add new point</h2>
            <form id="addPointForm">
                <input type="text" id="modelName" placeholder="Model name" required>
                <input type="number" id="delayMinutes" placeholder="Delay in minutes (optional)" min="0">
                <button type="submit" id="createPointBtn">Create point</button>
            </form>
        </div>
    </div>

    <!-- Modal window for displaying QR code -->
    <div id="qrModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeQrModal()">&times;</span>
            <h2>QR code for model</h2>
            <div id="qrCodeDisplay"></div>
            <p>Save and print this QR code</p>
            <button onclick="downloadQR()">Download QR code</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –ê–î–ú–ò–ù –ü–ê–ù–ï–õ–¨
        console.log('üõ°Ô∏è Admin panel - Fixed version initialization');
        
        // Global variables
        let adminMap = null;
        let adminMarkers = [];
        let isAddMode = false;
        let currentPassword = '';
        let allPoints = [];
        let currentQRCode = '';
        let isInitialized = false;
        let isLoading = false;

        // Almaty coordinates
        const ALMATY_CENTER = [43.2220, 76.8512];

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ DOM ready, starting admin panel');
            initializeAdminPanel();
        });

        // Main initialization function
        function initializeAdminPanel() {
            // Check saved password
            const savedPassword = sessionStorage.getItem('adminPassword');
            if (savedPassword) {
                console.log('üîë Found saved password, attempting auto-login');
                currentPassword = savedPassword;
                validatePasswordAndShowPanel(savedPassword);
            }
            
            setupEventListeners();
        }

        // Setup all event listeners
        function setupEventListeners() {
            // Password input handlers
            const passwordInput = document.getElementById('adminPassword');
            if (passwordInput) {
                passwordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        adminLogin();
                    }
                });
                
                // Clear error on input
                passwordInput.addEventListener('input', function() {
                    hideLoginError();
                });
            }

            // Form handler
            const form = document.getElementById('addPointForm');
            if (form) {
                form.addEventListener('submit', handleAddPointSubmit);
            }

            // Modal handlers
            window.addEventListener('click', function(event) {
                const addModal = document.getElementById('addPointModal');
                const qrModal = document.getElementById('qrModal');
                
                if (event.target === addModal) {
                    closeAddModal();
                }
                
                if (event.target === qrModal) {
                    closeQrModal();
                }
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    closeAddModal();
                    closeQrModal();
                }
                
                // Only if admin panel is visible
                const adminPanel = document.getElementById('adminPanel');
                if (adminPanel && adminPanel.style.display !== 'none') {
                    if (event.ctrlKey && event.key === 'l') {
                        event.preventDefault();
                        getAdminLocation();
                    }
                    
                    if (event.ctrlKey && event.key === 'a') {
                        event.preventDefault();
                        toggleAddMode();
                    }
                }
            });

            // Window resize handler
            window.addEventListener('resize', function() {
                if (adminMap) {
                    clearTimeout(window.adminResizeTimeout);
                    window.adminResizeTimeout = setTimeout(() => {
                        adminMap.invalidateSize();
                    }, 150);
                }
            });
        }

        // Login function
        function adminLogin() {
            const password = document.getElementById('adminPassword').value;
            const loginBtn = document.getElementById('loginBtn');
            
            if (!password) {
                showLoginError('Enter password');
                return;
            }
            
            // Disable button during login
            loginBtn.disabled = true;
            loginBtn.textContent = 'Checking...';
            hideLoginError();
            
            console.log('üîê Attempting admin login...');
            validatePasswordAndShowPanel(password);
        }

        // Validate password and show panel
        async function validatePasswordAndShowPanel(password) {
            try {
                const isValid = await checkPassword(password);
                
                if (isValid) {
                    currentPassword = password;
                    sessionStorage.setItem('adminPassword', password);
                    await showAdminPanel();
                } else {
                    showLoginError('Invalid administrator password');
                    sessionStorage.removeItem('adminPassword');
                    currentPassword = '';
                }
            } catch (error) {
                console.error('‚ùå Login error:', error);
                showLoginError('Connection error. Check server availability.');
                sessionStorage.removeItem('adminPassword');
                currentPassword = '';
            } finally {
                // Restore login button
                const loginBtn = document.getElementById('loginBtn');
                loginBtn.disabled = false;
                loginBtn.textContent = 'Login';
            }
        }

        // Check password with server
        async function checkPassword(password) {
            try {
                console.log('üîê Checking password with server...');
                
                const response = await fetch('/api/admin/points', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'Authorization': password
                    },
                    timeout: 10000
                });
                
                console.log('üì° Password check response:', response.status);
                
                if (response.status === 401) {
                    return false;
                }
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                return true;
                
            } catch (error) {
                console.error('‚ùå Password check error:', error);
                throw error;
            }
        }

        // Show admin panel
        async function showAdminPanel() {
            try {
                console.log('üõ°Ô∏è Showing admin panel...');
                
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                
                // Initialize map with retry logic
                await initAdminMapWithRetry();
                
                // Load points
                await loadAdminPoints();
                
                console.log('‚úÖ Admin panel ready');
                
            } catch (error) {
                console.error('‚ùå Admin panel initialization error:', error);
                showNotification('Panel initialization error: ' + error.message, 'error');
                
                // Return to login on error
                document.getElementById('adminPanel').style.display = 'none';
                document.getElementById('loginForm').style.display = 'block';
                sessionStorage.removeItem('adminPassword');
                currentPassword = '';
            }
        }

        // Initialize admin map with retry logic
        async function initAdminMapWithRetry(maxRetries = 3) {
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    console.log(`üó∫Ô∏è Admin map initialization attempt ${attempt}/${maxRetries}`);
                    await initAdminMap();
                    return; // Success
                } catch (error) {
                    console.error(`‚ùå Map init attempt ${attempt} failed:`, error);
                    
                    if (attempt === maxRetries) {
                        throw new Error('Failed to initialize map after ' + maxRetries + ' attempts');
                    }
                    
                    // Wait before retry
                    await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
                }
            }
        }

        // Initialize admin map
        function initAdminMap() {
            return new Promise((resolve, reject) => {
                try {
                    console.log('üó∫Ô∏è Creating admin map...');
                    
                    // Check Leaflet availability
                    if (typeof L === 'undefined') {
                        throw new Error('Leaflet not loaded');
                    }
                    
                    const mapElement = document.getElementById('adminMap');
                    if (!mapElement) {
                        throw new Error('Map element not found');
                    }
                    
                    // Remove existing map if any
                    if (adminMap) {
                        adminMap.remove();
                        adminMap = null;
                    }
                    
                    // Create map
                    adminMap = L.map('adminMap', {
                        center: ALMATY_CENTER,
                        zoom: 13,
                        zoomControl: true,
                        preferCanvas: true
                    });
                    
                    // Add tile layer
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap contributors',
                        maxZoom: 18,
                        tileSize: 256,
                        crossOrigin: true
                    }).addTo(adminMap);
                    
                    // Add click handler for adding points
                    adminMap.on('click', function(e) {
                        if (isAddMode) {
                            openAddPointModal(e.latlng);
                        }
                    });
                    
                    // Wait for map to be ready
                    adminMap.whenReady(() => {
                        setTimeout(() => {
                            if (adminMap) {
                                adminMap.invalidateSize();
                                isInitialized = true;
                                console.log('‚úÖ Admin map ready');
                                resolve();
                            }
                        }, 300);
                    });
                    
                } catch (error) {
                    console.error('‚ùå Admin map creation error:', error);
                    reject(error);
                }
            });
        }

        // Load admin points
        async function loadAdminPoints() {
            if (isLoading) {
                console.log('‚è≥ Points loading already in progress');
                return;
            }
            
            isLoading = true;
            
            try {
                console.log('üìç Loading admin points...');
                
                const response = await fetch('/api/admin/points', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'Authorization': currentPassword
                    }
                });
                
                console.log('üì° Admin points response:', response.status);
                
                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('Invalid password');
                    }
                    throw new Error(`Server error: ${response.status}`);
                }
                
                allPoints = await response.json();
                console.log('‚úÖ Loaded admin points:', allPoints.length);
                
                updateAdminMap();
                updateAdminStats();
                updatePointsList();
                
            } catch (error) {
                console.error('‚ùå Admin points loading error:', error);
                
                if (error.message.includes('Invalid password')) {
                    showNotification('Session expired. Please login again.', 'error');
                    logout();
                } else {
                    showNotification('Failed to load points: ' + error.message, 'error');
                }
            } finally {
                isLoading = false;
            }
        }

        // Update admin map
        function updateAdminMap() {
            if (!adminMap || !allPoints) {
                console.warn('‚ö†Ô∏è Map or points not ready for update');
                return;
            }
            
            console.log('üó∫Ô∏è Updating admin map with', allPoints.length, 'points');
            
            // Clear existing markers
            adminMarkers.forEach(marker => {
                if (adminMap.hasLayer(marker)) {
                    adminMap.removeLayer(marker);
                }
            });
            adminMarkers = [];
            
            // Add new markers
            allPoints.forEach(point => {
                try {
                    const now = new Date();
                    const isScheduled = new Date(point.scheduledTime) > now;
                    const isCollected = point.status === 'collected';
                    
                    let iconColor = '#4CAF50'; // green for available
                    if (isCollected) iconColor = '#f44336'; // red for collected
                    else if (isScheduled) iconColor = '#ff9800'; // orange for scheduled
                    
                    const icon = L.divIcon({
                        className: 'admin-marker',
                        html: `<div class="admin-marker-dot" style="background: ${iconColor};">
                                 ${isScheduled ? '‚è±Ô∏è' : (isCollected ? '‚úÖ' : 'üì¶')}
                               </div>`,
                        iconSize: [32, 32],
                        iconAnchor: [16, 16]
                    });
                    
                    const marker = L.marker([point.coordinates.lat, point.coordinates.lng], { icon })
                        .addTo(adminMap);
                    
                    // Popup content
                    let popupContent = createAdminPopupContent(point, isScheduled);
                    marker.bindPopup(popupContent);
                    
                    adminMarkers.push(marker);
                } catch (error) {
                    console.error('‚ùå Marker creation error:', error, point);
                }
            });
            
            console.log('‚úÖ Added', adminMarkers.length, 'admin markers');
        }

        // Create admin popup content
        function createAdminPopupContent(point, isScheduled) {
            let content = `
                <div class="admin-popup">
                    <h3>${point.name}</h3>
                    <p><strong>ID:</strong> ${point.id}</p>
                    <p><strong>Status:</strong> ${getStatusText(point, isScheduled)}</p>
                    <p><strong>Created:</strong> ${new Date(point.createdAt).toLocaleString()}</p>
            `;
            
            if (isScheduled) {
                content += `<p><strong>Will appear:</strong> ${new Date(point.scheduledTime).toLocaleString()}</p>`;
            }
            
            if (point.status === 'collected') {
                content += `
                    <p><strong>Collected:</strong> ${new Date(point.collectedAt).toLocaleString()}</p>
                    <p><strong>Collector:</strong> ${point.collectorInfo.name}</p>
                `;
            }
            
            content += `
                    <div style="margin-top: 12px;">
                        <button onclick="showQRCode('${point.id}')" class="admin-btn">Show QR</button>
                        <button onclick="deletePoint('${point.id}')" class="admin-btn delete-btn">Delete</button>
                    </div>
                </div>
            `;
            
            return content;
        }

        // Get status text
        function getStatusText(point, isScheduled) {
            if (point.status === 'collected') return 'üî¥ Collected';
            if (isScheduled) return 'üü° Scheduled';
            return 'üü¢ Available';
        }

        // Update admin statistics
        function updateAdminStats() {
            const now = new Date();
            const total = allPoints.length;
            const scheduled = allPoints.filter(p => new Date(p.scheduledTime) > now && p.status !== 'collected').length;
            const active = allPoints.filter(p => new Date(p.scheduledTime) <= now && p.status === 'available').length;
            
            animateNumber(document.getElementById('totalPoints'), total);
            animateNumber(document.getElementById('activePoints'), active);
            animateNumber(document.getElementById('scheduledPoints'), scheduled);
        }

        // Update points list
        function updatePointsList() {
            const container = document.getElementById('pointsList');
            
            if (!container) {
                console.warn('‚ö†Ô∏è Points list container not found');
                return;
            }
            
            if (allPoints.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No points created</p>';
                return;
            }
            
            const sortedPoints = [...allPoints].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            container.innerHTML = sortedPoints.map(point => {
                const now = new Date();
                const isScheduled = new Date(point.scheduledTime) > now;
                const statusClass = point.status === 'collected' ? 'collected' : (isScheduled ? 'scheduled' : 'available');
                
                return `
                    <div class="point-item ${statusClass}">
                        <div class="point-header">
                            <h4>${point.name}</h4>
                            <span class="point-status">${getStatusText(point, isScheduled)}</span>
                        </div>
                        <p><strong>ID:</strong> ${point.id}</p>
                        <p><strong>Coordinates:</strong> ${point.coordinates.lat.toFixed(6)}, ${point.coordinates.lng.toFixed(6)}</p>
                        <p><strong>Created:</strong> ${new Date(point.createdAt).toLocaleString()}</p>
                        ${isScheduled ? `<p><strong>Will appear:</strong> ${new Date(point.scheduledTime).toLocaleString()}</p>` : ''}
                        ${point.status === 'collected' ? `
                            <p><strong>Collected:</strong> ${new Date(point.collectedAt).toLocaleString()}</p>
                            <p><strong>Collector:</strong> ${point.collectorInfo.name}</p>
                        ` : ''}
                        <div class="point-actions">
                            <button onclick="showQRCode('${point.id}')" class="admin-btn">QR code</button>
                            <button onclick="deletePoint('${point.id}')" class="admin-btn delete-btn">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Toggle add mode
        function toggleAddMode() {
            isAddMode = !isAddMode;
            const btn = document.getElementById('addModeBtn');
            
            if (isAddMode) {
                btn.textContent = 'Add mode: ON';
                btn.classList.add('active');
                if (adminMap) {
                    adminMap.getContainer().style.cursor = 'crosshair';
                }
                showNotification('Click on map to add point', 'info');
            } else {
                btn.textContent = 'Add mode: OFF';
                btn.classList.remove('active');
                if (adminMap) {
                    adminMap.getContainer().style.cursor = '';
                }
            }
        }

        // Open add point modal
        function openAddPointModal(latlng) {
            window.tempCoordinates = latlng;
            const modal = document.getElementById('addPointModal');
            const input = document.getElementById('modelName');
            
            if (modal && input) {
                modal.style.display = 'block';
                setTimeout(() => input.focus(), 100);
            }
        }

        // Close add modal
        function closeAddModal() {
            const modal = document.getElementById('addPointModal');
            const form = document.getElementById('addPointForm');
            
            if (modal) modal.style.display = 'none';
            if (form) form.reset();
            
            // Reset button state
            const btn = document.getElementById('createPointBtn');
            if (btn) {
                btn.disabled = false;
                btn.textContent = 'Create point';
            }
        }

        // Handle add point form submission
        async function handleAddPointSubmit(e) {
            e.preventDefault();
            
            const name = document.getElementById('modelName').value;
            const delayMinutes = document.getElementById('delayMinutes').value;
            const submitBtn = document.getElementById('createPointBtn');
            
            if (!window.tempCoordinates) {
                showNotification('Coordinates error', 'error');
                return;
            }
            
            if (!name || !name.trim()) {
                showNotification('Enter model name', 'error');
                return;
            }
            
            // Disable button
            submitBtn.disabled = true;
            submitBtn.textContent = 'Creating...';
            
            try {
                const requestData = {
                    name: name.trim(),
                    coordinates: {
                        lat: parseFloat(window.tempCoordinates.lat),
                        lng: parseFloat(window.tempCoordinates.lng)
                    },
                    delayMinutes: delayMinutes ? parseInt(delayMinutes) : 0
                };
                
                console.log('üì§ Creating point:', requestData);
                
                const response = await fetch('/api/admin/points', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'Authorization': currentPassword
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('Invalid password - session expired');
                    }
                    
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Server error: ${response.status}`);
                }
                
                const responseData = await response.json();
                console.log('‚úÖ Point created:', responseData);
                
                closeAddModal();
                showNotification('Point created successfully!', 'success');
                
                // Show QR code
                if (responseData.qrCode) {
                    setTimeout(() => showQRCode(responseData.id, responseData.qrCode), 500);
                }
                
                // Reload points
                await loadAdminPoints();
                
            } catch (error) {
                console.error('‚ùå Point creation error:', error);
                
                if (error.message.includes('session expired')) {
                    showNotification('Session expired. Please login again.', 'error');
                    logout();
                } else {
                    showNotification('Creation error: ' + error.message, 'error');
                }
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Create point';
            }
        }

        // Get admin location
        function getAdminLocation() {
            const locationBtn = document.querySelector('.location-btn');
            
            if (!navigator.geolocation) {
                showNotification('Geolocation not supported', 'error');
                return;
            }
            
            if (!adminMap) {
                showNotification('Map not ready', 'error');
                return;
            }
            
            const originalText = locationBtn.innerHTML;
            locationBtn.innerHTML = '‚è≥ Locating...';
            locationBtn.disabled = true;
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    // Remove previous marker
                    if (window.adminUserMarker) {
                        adminMap.removeLayer(window.adminUserMarker);
                    }
                    
                    // Create user marker
                    const userIcon = L.divIcon({
                        className: 'admin-user-location-marker',
                        html: `<div style="
                            background: linear-gradient(45deg, #667eea, #764ba2);
                            width: 26px; 
                            height: 26px; 
                            border-radius: 50%; 
                            border: 3px solid white; 
                            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                        "></div>`,
                        iconSize: [26, 26],
                        iconAnchor: [13, 13]
                    });
                    
                    window.adminUserMarker = L.marker([lat, lng], { icon: userIcon }).addTo(adminMap);
                    adminMap.flyTo([lat, lng], 16);
                    
                    showNotification('Location determined', 'success');
                    
                    locationBtn.innerHTML = originalText;
                    locationBtn.disabled = false;
                },
                function(error) {
                    console.error('‚ùå Geolocation error:', error);
                    
                    let errorMessage = 'Could not determine location';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = 'Geolocation access denied';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = 'Location unavailable';
                            break;
                        case error.TIMEOUT:
                            errorMessage = 'Timeout exceeded';
                            break;
                    }
                    
                    showNotification(errorMessage, 'error');
                    
                    locationBtn.innerHTML = originalText;
                    locationBtn.disabled = false;
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 300000
                }
            );
        }

        // Show QR code
        function showQRCode(pointId, qrCodeData = null) {
            if (qrCodeData) {
                currentQRCode = qrCodeData;
                displayQRModal(qrCodeData, pointId);
                return;
            }
            
            const point = allPoints.find(p => p.id === pointId);
            if (!point) {
                showNotification('Point not found', 'error');
                return;
            }
            
            currentQRCode = point.qrCode;
            displayQRModal(point.qrCode, pointId, point.name);
        }

        // Display QR modal
        function displayQRModal(qrCode, pointId, pointName = '') {
            const qrDisplay = document.getElementById('qrCodeDisplay');
            if (qrDisplay) {
                qrDisplay.innerHTML = `
                    <img src="${qrCode}" alt="QR code" style="max-width: 280px; border-radius: 12px;">
                    ${pointName ? `<p style="font-weight: 600; margin-top: 15px;"><strong>${pointName}</strong></p>` : ''}
                    <p style="color: #666;">ID: ${pointId}</p>
                `;
            }
            
            const modal = document.getElementById('qrModal');
            if (modal) {
                modal.style.display = 'block';
            }
        }

        // Close QR modal
        function closeQrModal() {
            const modal = document.getElementById('qrModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Download QR code
        function downloadQR() {
            if (!currentQRCode) return;
            
            const link = document.createElement('a');
            link.download = `plasticboy-qr-${Date.now()}.png`;
            link.href = currentQRCode;
            link.click();
        }

        // Delete point
        async function deletePoint(pointId) {
            if (!confirm('Are you sure you want to delete this point?')) {
                return;
            }
            
            try {
                console.log('üóëÔ∏è Deleting point:', pointId);
                
                const response = await fetch(`/api/admin/points/${pointId}`, {
                    method: 'DELETE',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'Authorization': currentPassword
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('Session expired');
                    }
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to delete point');
                }
                
                showNotification('Point deleted successfully', 'success');
                await loadAdminPoints();
                
            } catch (error) {
                console.error('‚ùå Point deletion error:', error);
                
                if (error.message.includes('Session expired')) {
                    showNotification('Session expired. Please login again.', 'error');
                    logout();
                } else {
                    showNotification('Deletion error: ' + error.message, 'error');
                }
            }
        }

        // Logout function
        function logout() {
            sessionStorage.removeItem('adminPassword');
            currentPassword = '';
            allPoints = [];
            
            if (adminMap) {
                adminMap.remove();
                adminMap = null;
            }
            
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('adminPassword').value = '';
            
            console.log('üëã Logged out from admin panel');
        }

        // Show/hide login error
        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }
        }

        function hideLoginError() {
            const errorDiv = document.getElementById('loginError');
            if (errorDiv) {
                errorDiv.style.display = 'none';
            }
        }

        // Animate number changes
        function animateNumber(element, targetValue) {
            if (!element) return;
            
            const currentValue = parseInt(element.textContent) || 0;
            if (currentValue === targetValue) return;
            
            const duration = 600;
            const steps = 20;
            const stepValue = (targetValue - currentValue) / steps;
            const stepDuration = duration / steps;
            
            let current = currentValue;
            let step = 0;
            
            element.style.transform = 'scale(1.1)';
            element.style.transition = 'transform 0.3s ease';
            
            const timer = setInterval(() => {
                step++;
                current += stepValue;
                
                if (step >= steps) {
                    element.textContent = targetValue;
                    element.style.transform = 'scale(1)';
                    clearInterval(timer);
                } else {
                    element.textContent = Math.round(current);
                }
            }, stepDuration);
        }

        // Enhanced notification system
        function showNotification(message, type = 'info') {
            console.log(`üîî Notification: ${type} - ${message}`);
            
            // Remove existing notifications
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(n => n.remove());
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <span>${getNotificationIcon(type)} ${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()">√ó</button>
                </div>
            `;
            
            // Add styles if not exist
            if (!document.getElementById('notification-styles')) {
                const style = document.createElement('style');
                style.id = 'notification-styles';
                style.textContent = `
                    .notification {
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        z-index: 2000;
                        background: rgba(255, 255, 255, 0.98);
                        border-radius: 12px;
                        box-shadow: 0 8px 32px rgba(0,0,0,0.15);
                        backdrop-filter: blur(10px);
                        padding: 16px;
                        min-width: 280px;
                        max-width: 400px;
                        animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                        border: 1px solid rgba(255,255,255,0.2);
                        font-weight: 500;
                    }
                    
                    .notification.error {
                        border-left: 4px solid #f44336;
                        background: linear-gradient(135deg, rgba(244, 67, 54, 0.05), rgba(255, 255, 255, 0.98));
                    }
                    
                    .notification.success {
                        border-left: 4px solid #4CAF50;
                        background: linear-gradient(135deg, rgba(76, 175, 80, 0.05), rgba(255, 255, 255, 0.98));
                    }
                    
                    .notification.info {
                        border-left: 4px solid #2196F3;
                        background: linear-gradient(135deg, rgba(33, 150, 243, 0.05), rgba(255, 255, 255, 0.98));
                    }
                    
                    .notification.warning {
                        border-left: 4px solid #ff9800;
                        background: linear-gradient(135deg, rgba(255, 152, 0, 0.05), rgba(255, 255, 255, 0.98));
                    }
                    
                    .notification-content {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    }
                    
                    .notification-content button {
                        background: none;
                        border: none;
                        font-size: 1.3rem;
                        cursor: pointer;
                        color: #999;
                        padding: 0;
                        margin: 0;
                        width: auto;
                        margin-left: 12px;
                        transition: color 0.3s;
                    }
                    
                    .notification-content button:hover {
                        color: #666;
                    }
                    
                    @keyframes slideIn {
                        from {
                            transform: translateX(100%) scale(0.9);
                            opacity: 0;
                        }
                        to {
                            transform: translateX(0) scale(1);
                            opacity: 1;
                        }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 5000);
        }

        // Get notification icon
        function getNotificationIcon(type) {
            const icons = {
                error: '‚ùå',
                success: '‚úÖ',
                info: '‚ÑπÔ∏è',
                warning: '‚ö†Ô∏è'
            };
            return icons[type] || icons.info;
        }

        // Global functions for HTML onclick handlers
        window.adminLogin = adminLogin;
        window.toggleAddMode = toggleAddMode;
        window.getAdminLocation = getAdminLocation;
        window.showQRCode = showQRCode;
        window.deletePoint = deletePoint;
        window.closeAddModal = closeAddModal;
        window.closeQrModal = closeQrModal;
        window.downloadQR = downloadQR;

        console.log('üõ°Ô∏è Admin panel - Fixed version ready');
    </script>
</body>
</html>
