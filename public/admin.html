<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>PlasticBoy - Admin Panel</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="style.css">
    <style>
        /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–æ–±–∏–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∞–¥–º–∏–Ω–∫–∏ */
        @media screen and (max-width: 768px) {
            .form-container {
                padding: 20px !important;
                margin: 10px !important;
            }
            
            .form-container h2 {
                font-size: 1.5rem !important;
                margin-bottom: 20px !important;
            }
            
            .form-container input[type="password"] {
                font-size: 16px !important; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç zoom –Ω–∞ iOS */
                padding: 18px !important;
                border-radius: 12px !important;
                border: 2px solid #ddd !important;
                width: 100% !important;
                box-sizing: border-box !important;
                -webkit-appearance: none !important;
                -webkit-border-radius: 12px !important;
            }
            
            .form-container input[type="password"]:focus {
                outline: none !important;
                border-color: #667eea !important;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1) !important;
            }
            
            .form-container button {
                font-size: 16px !important; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç zoom –Ω–∞ iOS */
                padding: 18px !important;
                margin-top: 15px !important;
                border-radius: 12px !important;
                background: linear-gradient(45deg, #667eea, #764ba2) !important;
                color: white !important;
                border: none !important;
                width: 100% !important;
                cursor: pointer !important;
                transition: all 0.3s !important;
                font-weight: 600 !important;
            }
            
            .form-container button:hover,
            .form-container button:focus {
                transform: translateY(-2px) !important;
                box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3) !important;
            }
            
            .form-container button:active {
                transform: translateY(0) !important;
            }
            
            /* –£–ª—É—á—à–µ–Ω–∏—è –¥–ª—è –∞–¥–º–∏–Ω –∫–æ–Ω—Ç—Ä–æ–ª–æ–≤ */
            .admin-controls {
                padding: 15px !important;
                margin: 10px !important;
            }
            
            .admin-controls h3 {
                font-size: 1.3rem !important;
            }
            
            #addModeBtn {
                font-size: 16px !important;
                padding: 15px 20px !important;
                margin-top: 10px !important;
            }
            
            /* –£–ª—É—á—à–µ–Ω–∏—è –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ */
            .stats.admin-stats {
                flex-direction: column !important;
                gap: 10px !important;
                padding: 15px !important;
                margin: 10px !important;
            }
            
            .stats.admin-stats .stat-item {
                display: flex !important;
                justify-content: space-between !important;
                align-items: center !important;
                padding: 10px !important;
                background: rgba(255,255,255,0.8) !important;
                border-radius: 10px !important;
            }
            
            /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
            .modal-content {
                margin: 20px !important;
                width: calc(100% - 40px) !important;
                max-height: 80vh !important;
                overflow-y: auto !important;
                padding: 20px !important;
            }
            
            .modal-content input,
            .modal-content button {
                font-size: 16px !important; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç zoom */
            }
            
            /* –°–ø–∏—Å–æ–∫ —Ç–æ—á–µ–∫ */
            .points-list {
                margin: 10px !important;
                padding: 15px !important;
            }
            
            .point-item {
                margin-bottom: 15px !important;
                padding: 15px !important;
            }
            
            .point-actions {
                display: flex !important;
                flex-direction: column !important;
                gap: 10px !important;
            }
            
            .admin-btn {
                width: 100% !important;
                margin: 0 !important;
                padding: 12px !important;
                font-size: 14px !important;
            }
        }
        
        /* iOS Safari —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Ñ–∏–∫—Å—ã */
        @supports (-webkit-touch-callout: none) {
            input[type="password"] {
                font-size: 16px !important;
                -webkit-appearance: none !important;
                border-radius: 12px !important;
            }
            
            button {
                font-size: 16px !important;
                -webkit-appearance: none !important;
                border-radius: 12px !important;
            }
        }
        
        /* –§–∏–∫—Å –¥–ª—è –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
        @media screen and (max-width: 400px) {
            .container {
                padding: 5px !important;
            }
            
            .header {
                padding: 15px !important;
                margin-bottom: 10px !important;
            }
            
            .header h1 {
                font-size: 1.8rem !important;
            }
            
            .form-container {
                padding: 15px !important;
                margin: 5px !important;
            }
        }
        
        /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å */
        .form-container input:invalid {
            border-color: #f44336 !important;
        }
        
        .form-container input:valid {
            border-color: #4CAF50 !important;
        }
        
        /* –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ */
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }
        
        .loading::after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid #667eea;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>üõ°Ô∏è PlasticBoy Admin</h1>
            <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ—á–∫–∞–º–∏ —Å–±–æ—Ä–∞</p>
        </header>

        <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –º–æ–±–∏–ª—å–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π -->
        <div id="loginForm" class="form-container">
            <h2>–í—Ö–æ–¥ –≤ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</h2>
            <div id="loginError" style="display: none; color: #f44336; margin-bottom: 15px; padding: 10px; background: rgba(244, 67, 54, 0.1); border-radius: 8px; font-size: 14px;"></div>
            <input type="password" 
                   id="adminPassword" 
                   placeholder="–ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"
                   autocomplete="current-password"
                   required
                   style="margin-bottom: 15px;">
            <button type="button" id="loginBtn" onclick="adminLogin()">–í–æ–π—Ç–∏</button>
            <div style="margin-top: 15px; font-size: 12px; color: #666; text-align: center;">
                –í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            </div>
        </div>

        <!-- –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å -->
        <div id="adminPanel" style="display: none;">
            <div class="admin-controls">
                <h3>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é —Ç–æ—á–∫—É</h3>
                <p>–ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –∫–∞—Ä—Ç–µ, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫—É</p>
                <button id="addModeBtn" onclick="toggleAddMode()">–†–µ–∂–∏–º –¥–æ–±–∞–≤–ª–µ–Ω–∏—è: –í–´–ö–õ</button>
            </div>

            <div class="stats admin-stats">
                <div class="stat-item">
                    <span class="stat-label">–í—Å–µ–≥–æ —Ç–æ—á–µ–∫</span>
                    <span class="stat-number" id="totalPoints">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö</span>
                    <span class="stat-number" id="activePoints">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö</span>
                    <span class="stat-number" id="scheduledPoints">0</span>
                </div>
            </div>

            <!-- –£–í–ï–õ–ò–ß–ï–ù–ù–ê–Ø –ö–ê–†–¢–ê –î–õ–Ø –ê–î–ú–ò–ù–ê -->
            <div class="map-container">
                <div id="adminMap"></div>
            </div>

            <!-- –ö–ù–û–ü–ö–ê –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ö–ê–†–¢–û–ô –î–õ–Ø –ê–î–ú–ò–ù–ê (—Ç–æ–ª—å–∫–æ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è) -->
            <div class="map-controls">
                <button class="control-btn location-btn" onclick="getAdminLocation()">
                    üìç –ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ
                </button>
            </div>

            <div class="points-list">
                <h3>–°–ø–∏—Å–æ–∫ —Ç–æ—á–µ–∫ (<span id="pointsCount">0</span>)</h3>
                <div id="pointsList">
                    <div style="text-align: center; padding: 20px; color: #666;">
                        –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...
                    </div>
                </div>
            </div>
            
            <!-- –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞ -->
            <div style="margin: 20px 10px; text-align: center;">
                <button onclick="adminLogout()" style="background: #f44336; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">
                    –í—ã–π—Ç–∏ –∏–∑ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏
                </button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ—á–∫–∏ -->
    <div id="addPointModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAddModal()">&times;</span>
            <h2>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é —Ç–æ—á–∫—É</h2>
            <form id="addPointForm">
                <input type="text" 
                       id="modelName" 
                       placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏" 
                       required
                       autocomplete="off"
                       style="margin-bottom: 15px;">
                <input type="number" 
                       id="delayMinutes" 
                       placeholder="–ó–∞–¥–µ—Ä–∂–∫–∞ –≤ –º–∏–Ω—É—Ç–∞—Ö (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" 
                       min="0"
                       autocomplete="off"
                       style="margin-bottom: 15px;">
                <button type="submit">–°–æ–∑–¥–∞—Ç—å —Ç–æ—á–∫—É</button>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è QR –∫–æ–¥–∞ -->
    <div id="qrModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeQrModal()">&times;</span>
            <h2>QR –∫–æ–¥ –¥–ª—è –º–æ–¥–µ–ª–∏</h2>
            <div id="qrCodeDisplay"></div>
            <p>–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏ —Ä–∞—Å–ø–µ—á–∞—Ç–∞–π—Ç–µ —ç—Ç–æ—Ç QR –∫–æ–¥</p>
            <button onclick="downloadQR()">–°–∫–∞—á–∞—Ç—å QR –∫–æ–¥</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // –ú–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è admin.js —Å —É–ª—É—á—à–µ–Ω–∏—è–º–∏
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏
        let adminMap;
        let adminMarkers = [];
        let isAddMode = false;
        let currentPassword = '';
        let allPoints = [];
        let currentQRCode = '';

        // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ê–ª–º–∞—Ç—ã
        const ALMATY_CENTER = [43.2220, 76.8512];

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Admin panel loading...');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –ø–∞—Ä–æ–ª—å
            const savedPassword = sessionStorage.getItem('adminPassword');
            if (savedPassword) {
                console.log('Found saved password');
                currentPassword = savedPassword;
                showAdminPanel();
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏ –∞–¥–º–∏–Ω–∞
            initAdminControlButtons();
            
            // –ú–æ–±–∏–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è
            initMobileEnhancements();
        });

        // –ú–æ–±–∏–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è
        function initMobileEnhancements() {
            // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º zoom –Ω–∞ iOS –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ –Ω–∞ input
            const inputs = document.querySelectorAll('input, button');
            inputs.forEach(input => {
                input.style.fontSize = '16px';
            });
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –≤ –ø–æ–ª–µ –ø–∞—Ä–æ–ª—è
            const passwordInput = document.getElementById('adminPassword');
            if (passwordInput) {
                passwordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        adminLogin();
                    }
                });
                
                // –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –ø–∞—Ä–æ–ª—è —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
                setTimeout(() => {
                    passwordInput.focus();
                }, 500);
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –∞–¥–º–∏–Ω–∞
        function initAdminControlButtons() {
            // –î–æ–∂–¥–µ–º—Å—è –ø–æ—è–≤–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏
            const checkAdminPanel = setInterval(() => {
                const adminPanel = document.getElementById('adminPanel');
                if (adminPanel && adminPanel.style.display !== 'none') {
                    const locationBtn = document.querySelector('.location-btn');
                    
                    if (locationBtn) {
                        // –î–æ–±–∞–≤–ª—è–µ–º —É–ª—É—á—à–µ–Ω–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                        locationBtn.addEventListener('touchstart', function() {
                            this.style.transform = 'translateY(-1px)';
                        });
                        
                        locationBtn.addEventListener('touchend', function() {
                            this.style.transform = '';
                        });
                        
                        locationBtn.addEventListener('mousedown', function() {
                            this.style.transform = 'translateY(-1px)';
                        });
                        
                        locationBtn.addEventListener('mouseup', function() {
                            this.style.transform = '';
                        });
                        
                        clearInterval(checkAdminPanel);
                    }
                }
            }, 100);
        }

        // –£–ª—É—á—à–µ–Ω–Ω—ã–π –≤—Ö–æ–¥ –≤ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å
        function adminLogin() {
            const password = document.getElementById('adminPassword').value;
            const loginBtn = document.getElementById('loginBtn');
            const loginError = document.getElementById('loginError');
            
            // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ—à–∏–±–∫–∏
            loginError.style.display = 'none';
            
            if (!password) {
                showLoginError('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å');
                return;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            loginBtn.disabled = true;
            loginBtn.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞...';
            loginBtn.classList.add('loading');
            
            currentPassword = password;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–æ–ª—å —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π –¥–ª—è UI
            setTimeout(async () => {
                try {
                    // –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–∞—Ä–æ–ª—è
                    const response = await fetch('/api/admin/points', {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'X-Admin-Password': encodeURIComponent(currentPassword)
                        }
                    });
                    
                    if (response.ok) {
                        sessionStorage.setItem('adminPassword', password);
                        showAdminPanel();
                    } else {
                        throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    showLoginError('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞');
                    currentPassword = '';
                } finally {
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                    loginBtn.disabled = false;
                    loginBtn.textContent = '–í–æ–π—Ç–∏';
                    loginBtn.classList.remove('loading');
                }
            }, 500);
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É –≤—Ö–æ–¥–∞
        function showLoginError(message) {
            const loginError = document.getElementById('loginError');
            loginError.textContent = message;
            loginError.style.display = 'block';
            
            // –í—Å—Ç—Ä—è—Ö–∏–≤–∞–µ–º —Ñ–æ—Ä–º—É
            const loginForm = document.getElementById('loginForm');
            loginForm.style.animation = 'shake 0.5s ease-in-out';
            setTimeout(() => {
                loginForm.style.animation = '';
            }, 500);
        }

        // –í—ã—Ö–æ–¥ –∏–∑ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏
        function adminLogout() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏ –∏–∑ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏?')) {
                sessionStorage.removeItem('adminPassword');
                location.reload();
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å
        async function showAdminPanel() {
            console.log('Showing admin panel...');
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É
            setTimeout(() => {
                initAdminMap();
            }, 100);
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ—á–∫–∏
            await loadAdminPoints();
            
            // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
            setInterval(loadAdminPoints, 30000);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–¥–º–∏–Ω –∫–∞—Ä—Ç—ã —Å –º–æ–±–∏–ª—å–Ω—ã–º–∏ —É–ª—É—á—à–µ–Ω–∏—è–º–∏
        function initAdminMap() {
            console.log('Initializing admin map...');
            if (adminMap) {
                adminMap.remove();
            }
            
            try {
                // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
                adminMap = L.map('adminMap', {
                    center: ALMATY_CENTER,
                    zoom: 13,
                    zoomControl: true,
                    touchZoom: true,
                    doubleClickZoom: true,
                    scrollWheelZoom: true,
                    boxZoom: true,
                    keyboard: true,
                    dragging: true,
                    tap: true,
                    tapTolerance: 15
                });
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 18
                }).addTo(adminMap);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ—á–µ–∫
                adminMap.on('click', function(e) {
                    if (isAddMode) {
                        openAddPointModal(e.latlng);
                    }
                });
                
                // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä –∫–∞—Ä—Ç—ã –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
                setTimeout(() => {
                    adminMap.invalidateSize();
                }, 200);
                
                console.log('Admin map initialized successfully');
            } catch (error) {
                console.error('Error initializing map:', error);
                showNotification('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã', 'error');
            }
        }

        // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ admin.js...
        // (–∑–∞–≥—Ä—É–∑–∫–∞ —Ç–æ—á–µ–∫, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã, etc.)
        
        // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –¥–ª—è –∞–¥–º–∏–Ω–∞ (–º–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è)
        function getAdminLocation() {
            const locationBtn = document.querySelector('.location-btn');
            
            if (!navigator.geolocation) {
                showNotification('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è', 'error');
                return;
            }
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
            const originalText = locationBtn.innerHTML;
            locationBtn.innerHTML = '‚è≥ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ...';
            locationBtn.disabled = true;
            locationBtn.style.opacity = '0.8';
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    // –°–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    const userIcon = L.divIcon({
                        className: 'admin-user-location-marker',
                        html: `<div style="
                            background: linear-gradient(45deg, #667eea, #764ba2);
                            width: 26px; 
                            height: 26px; 
                            border-radius: 50%; 
                            border: 3px solid white; 
                            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                        "></div>`,
                        iconSize: [26, 26],
                        iconAnchor: [13, 13]
                    });
                    
                    // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –º–∞—Ä–∫–µ—Ä
                    if (window.adminUserMarker) {
                        adminMap.removeLayer(window.adminUserMarker);
                    }
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –º–∞—Ä–∫–µ—Ä
                    window.adminUserMarker = L.marker([lat, lng], { icon: userIcon })
                        .addTo(adminMap)
                        .bindPopup(`
                            <div style="text-align: center;">
                                <strong>üõ°Ô∏è –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∞</strong><br>
                                <small>${lat.toFixed(6)}, ${lng.toFixed(6)}</small>
                            </div>
                        `);
                    
                    // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É
                    adminMap.flyTo([lat, lng], 16, {
                        duration: 1.5
                    });
                    
                    showNotification('–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ', 'success');
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                    locationBtn.innerHTML = originalText;
                    locationBtn.disabled = false;
                    locationBtn.style.opacity = '';
                },
                function(error) {
                    console.error('Geolocation error:', error);
                    showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ', 'error');
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                    locationBtn.innerHTML = originalText;
                    locationBtn.disabled = false;
                    locationBtn.style.opacity = '';
                },
                {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 300000
                }
            );
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ—á–µ–∫ –¥–ª—è –∞–¥–º–∏–Ω–∞
        async function loadAdminPoints() {
            try {
                console.log('Loading admin points...');
                const response = await fetch('/api/admin/points', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'X-Admin-Password': encodeURIComponent(currentPassword)
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        showNotification('–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞', 'error');
                        adminLogout();
                        return;
                    }
                    throw new Error('Failed to load points');
                }
                
                allPoints = await response.json();
                console.log('Loaded points:', allPoints.length);
                
                updateAdminMap();
                updateAdminStats();
                updatePointsList();
                
            } catch (error) {
                console.error('Error loading points:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö', 'error');
            }
        }

        // –ü—Ä–æ—Å—Ç–∞—è —Ñ—É–Ω–∫—Ü–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        function showNotification(message, type = 'info') {
            console.log(`[${type.toUpperCase()}] ${message}`);
            
            // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 2000;
                background: ${type === 'error' ? '#f44336' : type === 'success' ? '#4CAF50' : '#2196F3'};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                font-size: 14px;
                max-width: 300px;
                word-wrap: break-word;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 4000);
        }

        // –ó–∞–≥–ª—É—à–∫–∏ –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π (–¥–æ–±–∞–≤–ª—è—Ç—å –ø–æ –º–µ—Ä–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)
        function updateAdminMap() {
            console.log('Updating admin map...');
            // –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        }

        function updateAdminStats() {
            console.log('Updating admin stats...');
            const totalElement = document.getElementById('totalPoints');
            const activeElement = document.getElementById('activePoints');
            const scheduledElement = document.getElementById('scheduledPoints');
            const countElement = document.getElementById('pointsCount');
            
            if (totalElement) totalElement.textContent = allPoints.length;
            if (countElement) countElement.textContent = allPoints.length;
            
            const now = new Date();
            const active = allPoints.filter(p => new Date(p.scheduledTime) <= now && p.status === 'available').length;
            const scheduled = allPoints.filter(p => new Date(p.scheduledTime) > now && p.status !== 'collected').length;
            
            if (activeElement) activeElement.textContent = active;
            if (scheduledElement) scheduledElement.textContent = scheduled;
        }

        function updatePointsList() {
            console.log('Updating points list...');
            const container = document.getElementById('pointsList');
            
            if (allPoints.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">–ù–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Ç–æ—á–µ–∫</p>';
                return;
            }
            
            container.innerHTML = `<p style="text-align: center; color: #666; padding: 20px;">–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${allPoints.length} —Ç–æ—á–µ–∫</p>`;
        }

        function toggleAddMode() {
            isAddMode = !isAddMode;
            const btn = document.getElementById('addModeBtn');
            
            if (isAddMode) {
                btn.textContent = '–†–µ–∂–∏–º –¥–æ–±–∞–≤–ª–µ–Ω–∏—è: –í–ö–õ';
                btn.style.background = '#f44336';
                showNotification('–ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –∫–∞—Ä—Ç–µ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ—á–∫–∏', 'info');
            } else {
                btn.textContent = '–†–µ–∂–∏–º –¥–æ–±–∞–≤–ª–µ–Ω–∏—è: –í–´–ö–õ';
                btn.style.background = '#4CAF50';
            }
        }

        function openAddPointModal(latlng) {
            showNotification('–§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ—á–µ–∫ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info');
        }

        function closeAddModal() {
            // –ó–∞–≥–ª—É—à–∫–∞
        }

        function closeQrModal() {
            // –ó–∞–≥–ª—É—à–∫–∞
        }

        function downloadQR() {
            // –ó–∞–≥–ª—É—à–∫–∞
        }

        // –î–æ–±–∞–≤–ª—è–µ–º CSS –∞–Ω–∏–º–∞—Ü–∏—é –≤—Å—Ç—Ä—è—Ö–∏–≤–∞–Ω–∏—è
        const shakeStyle = document.createElement('style');
        shakeStyle.textContent = `
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                25% { transform: translateX(-10px); }
                75% { transform: translateX(10px); }
            }
        `;
        document.head.appendChild(shakeStyle);
        
    </script>
</body>
</html>
