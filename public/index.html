<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlasticBoy - Карта моделей Алматы</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    
    <style>
        /* Стили для загрузочного экрана */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            transition: opacity 0.8s ease-out, transform 0.8s ease-out;
            font-family: 'Press Start 2P', monospace;
            color: #00ff00;
            overflow: hidden;
        }
        
        .loading-screen.fade-out {
            opacity: 0;
            transform: scale(1.1);
            pointer-events: none;
        }
        
        /* Анимированный фон с точками */
        .matrix-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            opacity: 0.3;
        }
        
        .matrix-dot {
            position: absolute;
            width: 2px;
            height: 2px;
            background: #00ff00;
            border-radius: 50%;
            animation: matrixFall 3s linear infinite;
        }
        
        @keyframes matrixFall {
            0% {
                transform: translateY(-10px);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(100vh);
                opacity: 0;
            }
        }
        
        /* Логотип и заголовок */
        .logo-container {
            text-align: center;
            margin-bottom: 60px;
            animation: logoGlow 2s ease-in-out infinite alternate;
        }
        
        .logo-title {
            font-size: 3rem;
            color: #00ff00;
            text-shadow: 
                0 0 5px #00ff00,
                0 0 10px #00ff00,
                0 0 15px #00ff00,
                0 0 20px #00ff00;
            margin-bottom: 20px;
            letter-spacing: 4px;
        }
        
        .logo-subtitle {
            font-size: 1rem;
            color: #00cccc;
            text-shadow: 0 0 5px #00cccc;
            opacity: 0.8;
            letter-spacing: 2px;
        }
        
        @keyframes logoGlow {
            0% {
                text-shadow: 
                    0 0 5px #00ff00,
                    0 0 10px #00ff00,
                    0 0 15px #00ff00,
                    0 0 20px #00ff00;
            }
            100% {
                text-shadow: 
                    0 0 10px #00ff00,
                    0 0 20px #00ff00,
                    0 0 30px #00ff00,
                    0 0 40px #00ff00;
            }
        }
        
        /* Прогресс бар в стиле ретро игр */
        .progress-container {
            width: 400px;
            background: #000;
            border: 3px solid #00ff00;
            border-radius: 0;
            padding: 8px;
            box-shadow: 
                inset 0 0 10px rgba(0, 255, 0, 0.3),
                0 0 20px rgba(0, 255, 0, 0.2);
            margin-bottom: 40px;
            position: relative;
        }
        
        .progress-bar {
            height: 20px;
            background: linear-gradient(90deg, #003300 0%, #00ff00 100%);
            width: 0%;
            transition: width 0.3s ease;
            position: relative;
            overflow: hidden;
            border-radius: 0;
        }
        
        .progress-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(255, 255, 255, 0.4) 50%, 
                transparent 100%);
            animation: progressShine 1.5s infinite;
        }
        
        @keyframes progressShine {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.8rem;
            color: #ffffff;
            text-shadow: 1px 1px 0px #000;
            z-index: 1;
            letter-spacing: 1px;
        }
        
        /* Статус загрузки */
        .loading-status {
            font-size: 1rem;
            color: #00cccc;
            margin-bottom: 30px;
            text-align: center;
            min-height: 30px;
            animation: textBlink 1.5s infinite;
            letter-spacing: 1px;
        }
        
        @keyframes textBlink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.6; }
        }
        
        /* Пиксельная анимация загрузки */
        .pixel-loader {
            display: flex;
            gap: 4px;
            margin-bottom: 20px;
        }
        
        .pixel-dot {
            width: 8px;
            height: 8px;
            background: #00ff00;
            border-radius: 0;
            animation: pixelPulse 1.4s infinite;
        }
        
        .pixel-dot:nth-child(2) { animation-delay: 0.2s; }
        .pixel-dot:nth-child(3) { animation-delay: 0.4s; }
        .pixel-dot:nth-child(4) { animation-delay: 0.6s; }
        .pixel-dot:nth-child(5) { animation-delay: 0.8s; }
        
        @keyframes pixelPulse {
            0%, 80%, 100% {
                background: #003300;
                box-shadow: none;
            }
            40% {
                background: #00ff00;
                box-shadow: 0 0 10px #00ff00;
            }
        }
        
        /* Сканлинии для эффекта старого монитора */
        .scanlines {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                transparent 50%, 
                rgba(0, 255, 0, 0.03) 50%
            );
            background-size: 100% 4px;
            pointer-events: none;
            animation: scanlineMove 0.1s linear infinite;
        }
        
        @keyframes scanlineMove {
            0% { transform: translateY(0); }
            100% { transform: translateY(4px); }
        }
        
        /* Эффект ЭЛТ монитора */
        .crt-effect {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at center, transparent 0%, rgba(0,0,0,0.3) 100%);
            pointer-events: none;
        }
        
        .loading-screen::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(90deg, transparent 50%, rgba(0,255,0,0.02) 50%),
                linear-gradient(rgba(18,16,16,0) 50%, rgba(0,0,0,.25) 50%);
            background-size: 2px 2px, 100% 2px;
            pointer-events: none;
        }
        
        /* Скрываем основной контент во время загрузки */
        .main-content {
            opacity: 0;
            transition: opacity 0.8s ease-in;
        }
        
        .main-content.loaded {
            opacity: 1;
        }
        
        /* Адаптивность */
        @media (max-width: 768px) {
            .logo-title {
                font-size: 2rem;
                letter-spacing: 2px;
            }
            
            .progress-container {
                width: 300px;
            }
            
            .loading-status {
                font-size: 0.8rem;
            }
        }
        
        @media (max-width: 480px) {
            .logo-title {
                font-size: 1.5rem;
                letter-spacing: 1px;
            }
            
            .logo-subtitle {
                font-size: 0.8rem;
            }
            
            .progress-container {
                width: 250px;
            }
            
            .loading-status {
                font-size: 0.7rem;
            }
        }
    </style>
</head>
<body>
    <!-- ЗАГРУЗОЧНЫЙ ЭКРАН -->
    <div class="loading-screen" id="loadingScreen">
        <!-- Анимированный фон матрицы -->
        <div class="matrix-bg" id="matrixBg"></div>
        
        <!-- Сканлинии для эффекта ЭЛТ монитора -->
        <div class="scanlines"></div>
        <div class="crt-effect"></div>
        
        <!-- Логотип -->
        <div class="logo-container">
            <div class="logo-title">PLASTICBOY</div>
            <div class="logo-subtitle">Almaty Collection System</div>
        </div>
        
        <!-- Пиксельная анимация загрузки -->
        <div class="pixel-loader">
            <div class="pixel-dot"></div>
            <div class="pixel-dot"></div>
            <div class="pixel-dot"></div>
            <div class="pixel-dot"></div>
            <div class="pixel-dot"></div>
        </div>
        
        <!-- Статус загрузки -->
        <div class="loading-status" id="loadingStatus">INITIALIZING SYSTEM...</div>
        
        <!-- Прогресс бар -->
        <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
            <div class="progress-text" id="progressText">0%</div>
        </div>
        
        <!-- Подсказка для пользователя -->
        <div style="position: absolute; bottom: 30px; text-align: center; color: #00cccc; font-size: 0.7rem; opacity: 0.7;">
            <div>💡 Нажмите ENTER для ускорения</div>
            <div style="margin-top: 5px;">🎮 Нажмите пробел для эффектов</div>
        </div>
    </div>

    <!-- ОСНОВНОЙ КОНТЕНТ ПРИЛОЖЕНИЯ -->
    <div class="main-content" id="mainContent">
        <div class="container">
            <header class="header">
                <h1>🎯 PlasticBoy</h1>
                <p>Collect'em all around Almaty</p>
            </header>

            <div class="stats">
                <div class="stat-item">
                    <span class="stat-number" id="availableCount">0</span>
                    <span class="stat-label">Доступно для сбора</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="collectedCount">0</span>
                    <span class="stat-label">Собрано другими</span>
                </div>
            </div>

            <div class="map-container">
                <div id="map"></div>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-dot green"></div>
                        <span>Доступные модели</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot red"></div>
                        <span>Собранные модели</span>
                    </div>
                </div>
            </div>

            <!-- КНОПКА ГЕОЛОКАЦИИ -->
            <div class="map-controls">
                <button class="control-btn location-btn" onclick="getCurrentLocation()">
                    📍 Моё местоположение
                </button>
            </div>
        </div>

        <!-- Модальное окно для информации о собранной модели -->
        <div id="infoModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal()">&times;</span>
                <h2 id="modalTitle">Информация о модели</h2>
                <div id="modalBody"></div>
            </div>
        </div>
    </div>

    <!-- Подключение библиотек -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Скрипт новой системы загрузки -->
    <script>
        // ОБНОВЛЕННАЯ СИСТЕМА ЗАГРУЗКИ В СТИЛЕ РЕТРО ИГР
        // Теперь загрузка ждет полной загрузки точек на карте

        // Флаги состояния загрузки
        let isMapReady = false;
        let arePointsLoaded = false;
        let isLeafletReady = false;
        let loadingStepsCompleted = 0;

        // Создание матричного фона
        function createMatrixDots() {
            const matrixBg = document.getElementById('matrixBg');
            const numberOfDots = 50;
            
            for (let i = 0; i < numberOfDots; i++) {
                const dot = document.createElement('div');
                dot.className = 'matrix-dot';
                dot.style.left = Math.random() * 100 + '%';
                dot.style.animationDelay = Math.random() * 3 + 's';
                dot.style.animationDuration = (Math.random() * 2 + 2) + 's';
                matrixBg.appendChild(dot);
            }
        }

        // Обновленные статусы загрузки с акцентом на карту
        const loadingSteps = [
            "INITIALIZING SYSTEM...",
            "LOADING GAME ASSETS...", 
            "CONNECTING TO ALMATY SERVER...",
            "CALIBRATING GPS MODULES...",
            "PREPARING MAP ENGINE...",
            "LOADING LEAFLET MAPS...",
            "ESTABLISHING MAP CONNECTION...",
            "SCANNING FOR MODEL POINTS...",
            "LOADING POINT DATA...",
            "SYNCHRONIZING MAP MARKERS...",
            "FINAL MAP VALIDATION...",
            "PLASTICBOY READY!"
        ];

        let currentStep = 0;
        let progress = 0;
        let loadingInterval;
        let mapCheckInterval;

        function updateLoadingScreen() {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const loadingStatus = document.getElementById('loadingStatus');
            
            // Определяем максимальный прогресс в зависимости от состояния
            let maxProgress = 85; // Максимум до загрузки точек
            
            if (isLeafletReady) maxProgress = 70;
            if (isMapReady) maxProgress = 80;
            if (arePointsLoaded) maxProgress = 100;
            
            // Обновляем прогресс с ограничением
            if (progress < maxProgress) {
                const increment = arePointsLoaded ? 15 : Math.random() * 8 + 3;
                progress += increment;
                if (progress > maxProgress) progress = maxProgress;
            }
            
            progressBar.style.width = progress + '%';
            progressText.textContent = Math.floor(progress) + '%';
            
            // Обновляем статус в зависимости от состояния загрузки
            updateLoadingStatus(loadingStatus);
            
            // Завершение загрузки только когда все готово
            if (arePointsLoaded && progress >= 100) {
                loadingStatus.textContent = loadingSteps[loadingSteps.length - 1];
                setTimeout(() => {
                    finishLoading();
                }, 1000);
                clearInterval(loadingInterval);
                return;
            }
        }

        function updateLoadingStatus(loadingStatus) {
            let targetStep = 0;
            
            if (!isLeafletReady) {
                targetStep = Math.min(4, Math.floor(progress / 15));
            } else if (!isMapReady) {
                targetStep = Math.min(6, 4 + Math.floor((progress - 40) / 10));
            } else if (!arePointsLoaded) {
                targetStep = Math.min(10, 7 + Math.floor((progress - 60) / 8));
            } else {
                targetStep = loadingSteps.length - 1;
            }
            
            if (targetStep > currentStep && currentStep < loadingSteps.length - 1) {
                currentStep = targetStep;
                loadingStatus.textContent = loadingSteps[currentStep];
                playLoadingSound();
            }
        }

        function playLoadingSound() {
            try {
                if (typeof AudioContext !== 'undefined' || typeof webkitAudioContext !== 'undefined') {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(400, audioContext.currentTime + 0.1);
                    
                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.1);
                }
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        // Функция проверки готовности карты и точек
        function checkMapAndPointsReady() {
            // Проверяем готовность Leaflet
            if (typeof L !== 'undefined' && !isLeafletReady) {
                isLeafletReady = true;
                console.log('✅ Leaflet готов');
            }
            
            // Проверяем готовность карты
            if (window.map && !isMapReady) {
                isMapReady = true;
                console.log('✅ Карта инициализирована');
            }
            
            // Проверяем загрузку точек (через глобальную переменную или DOM)
            if (!arePointsLoaded) {
                // Проверяем наличие маркеров на карте
                if (window.map && window.markers && window.markers.length > 0) {
                    arePointsLoaded = true;
                    console.log('✅ Точки на карте загружены');
                }
                // Альтернативный способ - проверяем статистику
                else if (document.getElementById('availableCount')) {
                    const availableCount = parseInt(document.getElementById('availableCount').textContent);
                    const collectedCount = parseInt(document.getElementById('collectedCount').textContent);
                    if (availableCount > 0 || collectedCount > 0) {
                        arePointsLoaded = true;
                        console.log('✅ Точки загружены (через статистику)');
                    }
                }
            }
        }

        function finishLoading() {
            const loadingScreen = document.getElementById('loadingScreen');
            const mainContent = document.getElementById('mainContent');
            
            console.log('🎯 Завершение загрузки - все компоненты готовы!');
            
            // Скрываем загрузочный экран
            loadingScreen.classList.add('fade-out');
            
            setTimeout(() => {
                loadingScreen.style.display = 'none';
                // Показываем основной контент
                mainContent.classList.add('loaded');
                
                // Показываем приветственное уведомление
                setTimeout(() => {
                    if (typeof showNotification === 'function') {
                        showNotification('PlasticBoy готов к работе! 🎯', 'success');
                    }
                }, 500);
            }, 800);
        }

        // Функция-хук для уведомления о загрузке точек
        function onPointsLoaded() {
            if (!arePointsLoaded) {
                arePointsLoaded = true;
                console.log('✅ Точки карты загружены (внешний вызов)');
            }
        }

        // Переопределяем функцию загрузки точек в основном скрипте
        function enhancedLoadPoints() {
            // Вызываем оригинальную функцию loadPoints
            if (typeof window.originalLoadPoints === 'function') {
                return window.originalLoadPoints().then(() => {
                    onPointsLoaded();
                });
            } else {
                // Если оригинальной функции нет, создаем свою
                return fetch('/api/points', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to load points');
                    }
                    return response.json();
                })
                .then(points => {
                    // Обновляем карту и статистику
                    if (typeof updateMap === 'function') updateMap(points);
                    if (typeof updateStats === 'function') updateStats(points);
                    
                    // Уведомляем о загрузке
                    onPointsLoaded();
                    return points;
                })
                .catch(error => {
                    console.error('Error loading points:', error);
                    if (typeof showNotification === 'function') {
                        showNotification('Ошибка загрузки данных', 'error');
                    }
                    // Помечаем как загруженные даже при ошибке, чтобы не блокировать интерфейс
                    onPointsLoaded();
                });
            }
        }

        // Запуск системы загрузки
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Запуск системы загрузки PlasticBoy');
            
            createMatrixDots();
            
            // Сохраняем оригинальную функцию loadPoints если она существует
            if (typeof loadPoints === 'function') {
                window.originalLoadPoints = loadPoints;
                // Переопределяем глобальную функцию
                window.loadPoints = enhancedLoadPoints;
            }
            
            // Запускаем проверку состояния
            mapCheckInterval = setInterval(checkMapAndPointsReady, 200);
            
            // Проверяем готовность основных ресурсов
            Promise.all([
                // Ждем загрузки Leaflet
                new Promise((resolve) => {
                    const checkLeaflet = () => {
                        if (typeof L !== 'undefined') {
                            isLeafletReady = true;
                            resolve();
                        } else {
                            setTimeout(checkLeaflet, 50);
                        }
                    };
                    checkLeaflet();
                }),
                
                // Ждем готовности DOM
                new Promise((resolve) => {
                    if (document.readyState === 'complete') {
                        resolve();
                    } else {
                        window.addEventListener('load', resolve);
                    }
                })
            ]).then(() => {
                console.log('📚 Основные ресурсы загружены, запуск анимации');
                
                // Начинаем анимацию загрузки
                setTimeout(() => {
                    loadingInterval = setInterval(updateLoadingScreen, 150);
                }, 300);
                
                // Инициализируем основное приложение через небольшую задержку
                setTimeout(() => {
                    initMainAppWithLoadingTracking();
                }, 500);
            });
            
            // Дополнительные матричные точки
            setInterval(() => {
                if (!arePointsLoaded) {
                    const matrixBg = document.getElementById('matrixBg');
                    if (matrixBg && matrixBg.children.length < 100) {
                        for (let i = 0; i < 3; i++) {
                            const dot = document.createElement('div');
                            dot.className = 'matrix-dot';
                            dot.style.left = Math.random() * 100 + '%';
                            dot.style.animationDelay = Math.random() * 3 + 's';
                            dot.style.animationDuration = (Math.random() * 2 + 2) + 's';
                            matrixBg.appendChild(dot);
                        }
                    }
                }
            }, 2000);
        });

        // Инициализация основного приложения с отслеживанием загрузки
        function initMainAppWithLoadingTracking() {
            console.log('🗺️ Инициализация карты и загрузка точек');
            
            // Инициализируем карту
            if (typeof initMap === 'function') {
                initMap();
                
                // Проверяем готовность карты через небольшой интервал
                const checkMap = setInterval(() => {
                    if (window.map && !isMapReady) {
                        isMapReady = true;
                        clearInterval(checkMap);
                        console.log('✅ Карта готова, загружаем точки');
                        
                        // Теперь загружаем точки
                        if (typeof enhancedLoadPoints === 'function') {
                            enhancedLoadPoints();
                        }
                    }
                }, 100);
            }
        }

        // Интерактивность для ускорения загрузки
        document.addEventListener('keydown', function(e) {
            if (!arePointsLoaded) {
                switch(e.key) {
                    case 'Enter':
                        progress += 10;
                        playLoadingSound();
                        break;
                    case ' ':
                        const matrixBg = document.getElementById('matrixBg');
                        if (matrixBg) {
                            for (let i = 0; i < 10; i++) {
                                const dot = document.createElement('div');
                                dot.className = 'matrix-dot';
                                dot.style.left = Math.random() * 100 + '%';
                                dot.style.animationDelay = '0s';
                                dot.style.animationDuration = '1s';
                                matrixBg.appendChild(dot);
                            }
                        }
                        break;
                    case 'Escape':
                        if (e.ctrlKey) {
                            // Принудительно завершаем загрузку (для разработки)
                            arePointsLoaded = true;
                            progress = 100;
                        }
                        break;
                }
            }
        });

        // Клик для ускорения (мобильные устройства)
        document.addEventListener('click', function(e) {
            if (!arePointsLoaded && e.target.closest('.loading-screen')) {
                progress += 5;
                playLoadingSound();
            }
        });

        // Предотвращение закрытия во время загрузки
        window.addEventListener('beforeunload', function(e) {
            if (!arePointsLoaded) {
                e.preventDefault();
                e.returnValue = 'PlasticBoy еще загружается. Вы уверены?';
            }
        });

        // Очистка интервалов при завершении загрузки
        function cleanup() {
            if (loadingInterval) {
                clearInterval(loadingInterval);
                loadingInterval = null;
            }
            if (mapCheckInterval) {
                clearInterval(mapCheckInterval);
                mapCheckInterval = null;
            }
        }

        // Вызываем очистку при завершении загрузки
        const originalFinishLoading = finishLoading;
        finishLoading = function() {
            cleanup();
            originalFinishLoading();
        };

        // Экспорт функций для внешнего использования
        window.PlasticBoyLoader = {
            onPointsLoaded,
            checkMapAndPointsReady,
            enhancedLoadPoints,
            isMapReady: () => isMapReady,
            arePointsLoaded: () => arePointsLoaded,
            isLeafletReady: () => isLeafletReady
        };

        console.log('🎮 Система загрузки PlasticBoy инициализирована');
    </script>
    
    <!-- Основной скрипт приложения -->
    <script src="script.js"></script>
</body>
</html>
