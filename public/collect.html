<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlasticBoy - –°–±–æ—Ä –º–æ–¥–µ–ª–∏</title>
    <link rel="stylesheet" href="style.css">
    <!-- Preload –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
</head>
<body>
    <div class="container collect-container">
        <header class="header">
            <h1>üéâ –û—Ç–ª–∏—á–Ω–∞—è –Ω–∞—Ö–æ–¥–∫–∞!</h1>
            <p>–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ–±–µ</p>
        </header>

        <div id="collectForm" class="form-container">
            <div class="model-info">
                <h2 id="modelName">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
                <p id="modelLocation"></p>
            </div>

            <div id="collectFormInner">
                <div class="form-group">
                    <label for="collectorName">–í–∞—à–µ –∏–º—è:</label>
                    <input type="text" id="collectorName" name="name" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è" required autocomplete="name">
                </div>

                <div class="form-group">
                    <label for="signature">–ü–æ–¥–ø–∏—Å—å/–°–æ–æ–±—â–µ–Ω–∏–µ:</label>
                    <textarea id="signature" name="signature" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ —Å–≤–æ—é –ø–æ–¥–ø–∏—Å—å –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" rows="3"></textarea>
                </div>

                <div class="form-group">
                    <label for="selfie">–°–µ–ª—Ñ–∏ —Å –º–µ—Å—Ç–∞ –Ω–∞—Ö–æ–¥–∫–∏:</label>
                    <input type="file" id="selfie" name="selfie" accept="image/*" capture="user">
                    <div id="compressionInfo" style="display: none; color: #666; font-size: 0.9rem; margin-top: 5px;">
                        –°–∂–∏–º–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∑–∞–≥—Ä—É–∑–∫–∏...
                    </div>
                    <div id="imagePreview"></div>
                </div>

                <button type="button" id="submitBtn" class="collect-btn">
                    <span>üì∏</span>
                    –û—Ç–º–µ—Ç–∏—Ç—å –Ω–∞—Ö–æ–¥–∫—É
                </button>
            </div>
        </div>

        <div id="successMessage" class="success-message" style="display: none;">
            <h2>üéØ –£—Å–ø–µ—à–Ω–æ!</h2>
            <p>–°–ø–∞—Å–∏–±–æ –∑–∞ —É—á–∞—Å—Ç–∏–µ –≤ PlasticBoy!</p>
            <p>–í–∞—à–∞ –Ω–∞—Ö–æ–¥–∫–∞ –æ—Ç–º–µ—á–µ–Ω–∞ –Ω–∞ –∫–∞—Ä—Ç–µ.</p>
            <button onclick="window.location.href='/'">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∫–∞—Ä—Ç–µ</button>
        </div>

        <div id="errorMessage" class="error-message" style="display: none;">
            <h2>üòî –û—à–∏–±–∫–∞</h2>
            <p id="errorText">–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫...</p>
            <button onclick="window.location.href='/'">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∫–∞—Ä—Ç–µ</button>
        </div>
    </div>

    <script>
        // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–∂–∞—Ç–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        function compressImage(file, maxWidth = 1920, quality = 0.8) {
            return new Promise((resolve, reject) => {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–∂–∞—Ç–∏—è
                document.getElementById('compressionInfo').style.display = 'block';
                
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = () => {
                    try {
                        // –í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤—ã–µ —Ä–∞–∑–º–µ—Ä—ã —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–π
                        let { width, height } = img;
                        
                        // –¢–æ–ª—å–∫–æ —Å–∂–∏–º–∞–µ–º, –µ—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–æ–ª—å—à–µ maxWidth
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        // –†–∏—Å—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π
                        ctx.fillStyle = '#FFFFFF';
                        ctx.fillRect(0, 0, width, height);
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ base64 —Å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–º –∫–∞—á–µ—Å—Ç–≤–æ–º
                        canvas.toBlob((blob) => {
                            const reader = new FileReader();
                            reader.onload = () => {
                                document.getElementById('compressionInfo').style.display = 'none';
                                resolve(reader.result);
                            };
                            reader.onerror = reject;
                            reader.readAsDataURL(blob);
                        }, 'image/jpeg', quality);
                        
                        // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–∞–º—è—Ç—å
                        URL.revokeObjectURL(img.src);
                        
                    } catch (error) {
                        document.getElementById('compressionInfo').style.display = 'none';
                        reject(error);
                    }
                };
                
                img.onerror = () => {
                    document.getElementById('compressionInfo').style.display = 'none';
                    reject(new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è'));
                };
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º createObjectURL –¥–ª—è –ª—É—á—à–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                img.src = URL.createObjectURL(file);
            });
        }

        // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
        const urlParams = new URLSearchParams(window.location.search);
        const pointId = urlParams.get('id');
        const secret = urlParams.get('secret');

        console.log('Point ID:', pointId, 'Secret:', secret);

        if (!pointId || !secret) {
            showError('–ù–µ–≤–µ—Ä–Ω–∞—è —Å—Å—ã–ª–∫–∞ QR –∫–æ–¥–∞');
        } else {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ—á–∫–µ
            loadPointInfo();
        }

        // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–æ—á–∫–µ
        async function loadPointInfo() {
            try {
                console.log('Loading point info...');
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –¥–ª—è –æ—Ç–º–µ–Ω—ã –∑–∞–ø—Ä–æ—Å–∞ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 —Å–µ–∫—É–Ω–¥ —Ç–∞–π–º–∞—É—Ç
                
                const response = await fetch(`/api/collect/${pointId}?secret=${encodeURIComponent(secret)}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    },
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                
                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);

                if (!response.ok) {
                    throw new Error(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
                }

                document.getElementById('modelName').textContent = data.name;
                document.getElementById('modelLocation').textContent = 
                    `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${data.coordinates.lat.toFixed(6)}, ${data.coordinates.lng.toFixed(6)}`;

            } catch (error) {
                console.error('Error loading point info:', error);
                if (error.name === 'AbortError') {
                    showError('–í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.');
                } else {
                    showError(error.message);
                }
            }
        }

        // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞ —Å –ª–µ–Ω–∏–≤—ã–º —Å–∂–∞—Ç–∏–µ–º
        let originalFile = null;
        let compressedDataUrl = null;

        document.getElementById('selfie').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            const preview = document.getElementById('imagePreview');
            
            if (file) {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª
                originalFile = file;
                compressedDataUrl = null;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Ñ–∞–π–ª–∞
                const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
                if (!allowedTypes.includes(file.type.toLowerCase())) {
                    alert('–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ñ–æ—Ä–º–∞—Ç—ã: JPEG, PNG, WebP');
                    this.value = '';
                    preview.innerHTML = '';
                    originalFile = null;
                    return;
                }

                console.log(`–í—ã–±—Ä–∞–Ω —Ñ–∞–π–ª: ${file.name}, —Ä–∞–∑–º–µ—Ä: ${(file.size / 1024 / 1024).toFixed(2)}MB`);

                try {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –±–µ–∑ —Å–∂–∞—Ç–∏—è –¥–ª—è UX
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const sizeInfo = file.size > 1024 * 1024 ? 
                            `<p style="color: #666; font-size: 0.8rem;">–†–∞–∑–º–µ—Ä: ${(file.size / 1024 / 1024).toFixed(2)}MB</p>` : '';
                        
                        preview.innerHTML = `
                            <img src="${e.target.result}" alt="–ü—Ä–µ–≤—å—é —Å–µ–ª—Ñ–∏" style="max-width: 100%; max-height: 200px; border-radius: 10px;">
                            ${sizeInfo}
                        `;
                    };
                    reader.readAsDataURL(file);
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
                }
            } else {
                preview.innerHTML = '';
                originalFile = null;
                compressedDataUrl = null;
            }
        });

        // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å –ª–µ–Ω–∏–≤—ã–º —Å–∂–∞—Ç–∏–µ–º
        document.getElementById('submitBtn').addEventListener('click', async function(e) {
            e.preventDefault();
            
            const name = document.getElementById('collectorName').value.trim();
            if (!name) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è');
                document.getElementById('collectorName').focus();
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span>‚è≥</span> –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...';

            try {
                console.log('Submitting form...');
                
                const formData = new FormData();
                formData.append('secret', secret);
                formData.append('name', name);
                formData.append('signature', document.getElementById('signature').value.trim());
                
                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–µ–ª—Ñ–∏ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ
                if (originalFile) {
                    console.log('Processing selfie for upload...');
                    submitBtn.innerHTML = '<span>üîÑ</span> –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ...';
                    
                    try {
                        // –°–∂–∏–º–∞–µ–º —Ç–æ–ª—å–∫–æ –±–æ–ª—å—à–∏–µ —Ñ–∞–π–ª—ã (> 2MB)
                        if (originalFile.size > 2 * 1024 * 1024) {
                            console.log('Compressing large image...');
                            compressedDataUrl = await compressImage(originalFile, 1920, 0.85);
                            
                            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º data URL –æ–±—Ä–∞—Ç–Ω–æ –≤ Blob –¥–ª—è FormData
                            const response = await fetch(compressedDataUrl);
                            const blob = await response.blob();
                            formData.append('selfie', blob, 'compressed_selfie.jpg');
                            
                            console.log(`Image compressed: ${(originalFile.size / 1024 / 1024).toFixed(2)}MB -> ${(blob.size / 1024 / 1024).toFixed(2)}MB`);
                        } else {
                            // –î–ª—è –Ω–µ–±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª
                            console.log('Using original file (small size)');
                            formData.append('selfie', originalFile);
                        }
                    } catch (compressionError) {
                        console.warn('Compression failed, using original:', compressionError);
                        formData.append('selfie', originalFile);
                    }
                }

                submitBtn.innerHTML = '<span>üì§</span> –û—Ç–ø—Ä–∞–≤–∫–∞...';
                console.log('Sending request to:', `/api/collect/${pointId}`);

                // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –¥–ª—è –æ—Ç–º–µ–Ω—ã –¥–ª–∏–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000); // 60 —Å–µ–∫—É–Ω–¥ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏

                const response = await fetch(`/api/collect/${pointId}`, {
                    method: 'POST',
                    body: formData,
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('Response result:', result);

                if (!response.ok) {
                    throw new Error(result.error || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏');
                }

                console.log('Success!');
                showSuccess();

            } catch (error) {
                console.error('Error submitting form:', error);
                
                if (error.name === 'AbortError') {
                    showError('–í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–µ–∫–ª–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                } else {
                    showError(error.message);
                }
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<span>üì∏</span> –û—Ç–º–µ—Ç–∏—Ç—å –Ω–∞—Ö–æ–¥–∫—É';
            }
        });

        function showSuccess() {
            document.getElementById('collectForm').style.display = 'none';
            document.getElementById('successMessage').style.display = 'block';
        }

        function showError(message) {
            document.getElementById('collectForm').style.display = 'none';
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';
        }

        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') {
                e.preventDefault();
                document.getElementById('submitBtn').click();
            }
        });

        // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–∞–º—è—Ç—å –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', function() {
            if (originalFile && compressedDataUrl) {
                URL.revokeObjectURL(compressedDataUrl);
            }
        });

        // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É
        let isSubmitting = false;
        document.getElementById('submitBtn').addEventListener('click', function(e) {
            if (isSubmitting) {
                e.preventDefault();
                return false;
            }
            isSubmitting = true;
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã –Ω–∞ —Å–ª—É—á–∞–π –æ—à–∏–±–∫–∏
            setTimeout(() => {
                isSubmitting = false;
            }, 2000);
        });
    </script>
</body>
</html>
